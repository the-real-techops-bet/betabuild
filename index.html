<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Picture Puzzle Builder â€“ v0.13 (WebView Safe)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle at top, #f9fafb 0, #e0f2fe 35%, #ede9fe 75%, #fef3c7 100%);
  }
  .app {
    background: #ffffff;
    width: 100%;
    max-width: 920px;
    margin: 10px;
    padding: 16px 14px 18px;
    border-radius: 20px;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.32);
    border: 3px solid #bfdbfe;
  }
  .header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .header-icon {
    width: 52px;
    height: 52px;
    flex-shrink: 0;
  }
  .header h1 {
    margin: 0;
    font-size: 1.3rem;
    color: #0f172a;
  }
  .header p {
    margin: 2px 0 0;
    font-size: 0.9rem;
    color: #4b5563;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
  }
  .controls label {
    font-size: 0.85rem;
    color: #374151;
  }
  .file-input {
    display: none;
  }
  .btn-upload {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid #fbbf24;
    background: linear-gradient(135deg, #f97316, #facc15);
    color: #111827;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 6px 14px rgba(217, 119, 6, 0.6);
  }
  .btn-upload span {
    font-size: 1.1rem;
  }
  select {
    padding: 6px 8px;
    border-radius: 999px;
    border: 1px solid #cbd5f5;
    font-size: 0.85rem;
    outline: none;
  }
  select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #bfdbfe;
  }
  .btn {
    border-radius: 999px;
    border: none;
    padding: 8px 14px;
    font-size: 0.88rem;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }
  .btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: #fefce8;
    box-shadow: 0 6px 14px rgba(22, 163, 74, 0.7);
  }
  .btn-secondary {
    background: #e0f2fe;
    color: #0f172a;
    border: 1px solid #bae6fd;
  }
  .btn:disabled {
    opacity: 0.55;
    cursor: default;
    box-shadow: none;
  }
  .hint {
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 8px;
  }
  .main {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .preview-pane {
    flex: 0 0 220px;
    max-width: 220px;
  }
  .preview-box {
    border-radius: 14px;
    border: 2px dashed #d1d5db;
    background: #f9fafb;
    min-height: 170px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding: 4px;
  }
  .preview-box img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
  }
  .preview-label {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 4px;
  }
  .board-wrapper {
    flex: 1 1 0;
    min-width: 260px;
  }
  .board {
    position: relative;
    margin: 0 auto;
    border-radius: 16px;
    overflow: hidden;
    background: #e5e7eb;
    border: 2px solid #9ca3af;
    width: 100%;
    max-width: 520px;
  }
  .board-inner {
    position: relative;
    width: 100%;
    padding-top: 75%; /* 4:3 ratio */
  }
  .tiles-layer {
    position: absolute;
    inset: 0;
    display: grid;
    touch-action: manipulation;
  }
  .tile {
    position: relative;
    border: 1px solid rgba(15, 23, 42, 0.15);
    cursor: pointer;
    transition: box-shadow 0.12s ease, transform 0.08s ease;
    background-color: #020617;
  }
  .tile:hover {
    box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.8);
    transform: translateY(-1px);
  }
  .tile.correct {
    box-shadow: inset 0 0 0 2px rgba(34, 197, 94, 0.9);
  }
  .tile img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
  }
  .status-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
    font-size: 0.82rem;
    color: #374151;
  }
  .status-pill {
    border-radius: 999px;
    padding: 3px 8px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
  }
  .toast {
    position: fixed;
    left: 50%;
    bottom: 14px;
    transform: translateX(-50%);
    background: rgba(15, 23, 42, 0.94);
    color: #f9fafb;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.78rem;
    display: none;
    z-index: 999;
  }
  .toast.show {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    animation: fadeToast 2s ease-out forwards;
  }
  @keyframes fadeToast {
    0% { opacity: 0; transform: translate(-50%, 4px); }
    10% { opacity: 1; transform: translate(-50%, 0); }
    80% { opacity: 1; transform: translate(-50%, 0); }
    100% { opacity: 0; transform: translate(-50%, 4px); }
  }
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }
  .overlay-content {
    background: #ffffff;
    border-radius: 18px;
    padding: 14px 14px 12px;
    width: 90%;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 16px 50px rgba(15, 23, 42, 0.65);
  }
  .overlay-content h2 {
    font-size: 1.1rem;
    margin: 4px 0;
    color: #111827;
  }
  .overlay-content p {
    font-size: 0.9rem;
    color: #4b5563;
    margin: 4px 0 10px;
  }
  .overlay-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 6px;
  }
  @media (max-width: 640px) {
    .app { padding: 12px 10px 14px; }
    .main { flex-direction: column; }
    .preview-pane { max-width: 100%; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <svg class="header-icon" viewBox="0 0 200 200" aria-hidden="true">
      <defs>
        <linearGradient id="puzzGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#f97316"/>
          <stop offset="50%" stop-color="#facc15"/>
          <stop offset="100%" stop-color="#22c55e"/>
        </linearGradient>
      </defs>
      <path d="M60 40 h40 a10 10 0 0 1 10 10 v10 a10 10 0 1 0 10 0 V50 a10 10 0 0 1 10-10 h20 a10 10 0 0 1 10 10 v40 a10 10 0 0 1-10 10 h-10 a10 10 0 1 0 0 10 h10 a10 10 0 0 1 10 10 v30 a10 10 0 0 1-10 10 h-40 a10 10 0 0 1-10-10 v-10 a10 10 0 1 0-10 0 v10 a10 10 0 0 1-10 10 H50 a10 10 0 0 1-10-10 v-40 a10 10 0 0 1 10-10 h10 a10 10 0 1 0 0-10 H50 a10 10 0 0 1-10-10 V50 a10 10 0 0 1 10-10z"
            fill="url(#puzzGrad)" stroke="#f97316" stroke-width="3" stroke-linejoin="round"/>
    </svg>
    <div>
      <h1>Picture Puzzle Builder</h1>
      <p>Upload a photo and turn it into a tap-to-swap puzzle with 5 to 100 pieces.</p>
    </div>
  </div>

  <div class="controls">
    <label>
      <input id="file-input" class="file-input" type="file" accept="image/*" />
      <span class="btn-upload"><span>ðŸ“·</span>Choose picture</span>
    </label>

    <label>
      Pieces:
      <select id="preset-select">
        <option value="2x3">Easy â€¢ 2 Ã— 3 (6)</option>
        <option value="3x3" selected>Classic â€¢ 3 Ã— 3 (9)</option>
        <option value="4x4">4 Ã— 4 (16)</option>
        <option value="5x5">5 Ã— 5 (25)</option>
        <option value="6x6">6 Ã— 6 (36)</option>
        <option value="8x8">8 Ã— 8 (64)</option>
        <option value="10x10">10 Ã— 10 (100)</option>
      </select>
    </label>

    <button id="start-btn" class="btn btn-primary" type="button" disabled>Start Puzzle</button>
    <button id="shuffle-btn" class="btn btn-secondary" type="button" disabled>Shuffle Again</button>
    <button id="reset-btn" class="btn btn-secondary" type="button" disabled>Show Original</button>
  </div>

  <div class="hint">
    1) Pick a picture. 2) Choose piece count. 3) Tap <strong>Start Puzzle</strong>. Tap one tile, then another, to swap them. Keep going until the picture looks right.
  </div>

  <div class="main">
    <div class="preview-pane">
      <div class="preview-box" id="preview-box">
        <span style="font-size:0.85rem;color:#9ca3af;text-align:center;padding:8px;">
          No picture yet. Choose a photo to see a preview and build a puzzle.
        </span>
      </div>
      <div class="preview-label" id="preview-label">
        Preview of your full image. The puzzle will match this shape.
      </div>
    </div>

    <div class="board-wrapper">
      <div class="board">
        <div class="board-inner">
          <div id="tiles-layer" class="tiles-layer"></div>
        </div>
      </div>
      <div class="status-bar">
        <span class="status-pill" id="status-size">Pieces: 0</span>
        <span class="status-pill" id="status-moves">Moves: 0</span>
        <span class="status-pill" id="status-message">Upload a picture to begin.</span>
      </div>
    </div>
  </div>

  <div id="done-overlay" class="overlay">
    <div class="overlay-content">
      <h2>Great job! ðŸŽ‰</h2>
      <p>You put all the pieces back where they belong.</p>
      <div class="overlay-buttons">
        <button id="done-close" class="btn btn-primary" type="button">OK</button>
        <button id="done-shuffle" class="btn btn-secondary" type="button">Shuffle and play again</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved</div>
</div>

<script>
  const fileInput = document.getElementById("file-input");
  const previewBox = document.getElementById("preview-box");
  const previewLabel = document.getElementById("preview-label");
  const presetSelect = document.getElementById("preset-select");
  const startBtn = document.getElementById("start-btn");
  const shuffleBtn = document.getElementById("shuffle-btn");
  const resetBtn = document.getElementById("reset-btn");
  const tilesLayer = document.getElementById("tiles-layer");
  const statusSize = document.getElementById("status-size");
  const statusMoves = document.getElementById("status-moves");
  const statusMessage = document.getElementById("status-message");
  const doneOverlay = document.getElementById("done-overlay");
  const doneClose = document.getElementById("done-close");
  const doneShuffle = document.getElementById("done-shuffle");
  const toast = document.getElementById("toast");

  let imageDataUrl = null; // processed image for puzzle
  let rows = 3;
  let cols = 3;
  let tiles = []; // {index, currentIndex, element}
  let moves = 0;
  let firstSelectedIndex = null;

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  }

  function setStatus(text) {
    statusMessage.textContent = text;
  }

  function updateSizeLabel() {
    statusSize.textContent = "Pieces: " + (rows * cols);
  }

  function updateMovesLabel() {
    statusMoves.textContent = "Moves: " + moves;
  }

  function parsePreset(value) {
    const parts = value.split("x");
    const r = parseInt(parts[0], 10) || 3;
    const c = parseInt(parts[1], 10) || 3;
    rows = r;
    cols = c;
    updateSizeLabel();
  }

  presetSelect.addEventListener("change", function() {
    parsePreset(this.value);
    if (imageDataUrl) {
      setStatus("Preset changed. Press Start Puzzle again to rebuild.");
    }
  });

  document.querySelector(".btn-upload").addEventListener("click", function() {
    fileInput.click();
  });

  fileInput.addEventListener("change", function(e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    if (!file.type || !file.type.startsWith("image/")) {
      showToast("Please choose an image file.");
      return;
    }

    // Loading state
    previewBox.innerHTML = '<span style="font-size:0.85rem;color:#6b7280;text-align:center;padding:8px;">Loading pictureâ€¦</span>';
    previewLabel.textContent = "Loading pictureâ€¦";
    startBtn.disabled = true;
    resetBtn.disabled = true;
    setStatus("Loading pictureâ€¦");

    const reader = new FileReader();

    reader.onload = function(evt) {
      const originalDataUrl = evt.target.result;
      // Use Image + canvas so WebView gets a clean JPEG under 1600px wide
      const baseImg = new Image();
      baseImg.onload = function() {
        const maxW = 1600;
        const maxH = 1200;
        let w = baseImg.width;
        let h = baseImg.height;
        const scale = Math.min(maxW / w, maxH / h, 1);
        const canvas = document.createElement("canvas");
        canvas.width = Math.round(w * scale);
        canvas.height = Math.round(h * scale);
        const ctx = canvas.getContext("2d");
        ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);
        imageDataUrl = canvas.toDataURL("image/jpeg", 0.9);

        const previewImg = new Image();
        previewImg.onload = function() {
          previewBox.innerHTML = "";
          previewBox.appendChild(previewImg);
          previewLabel.textContent = "Picture loaded. Choose pieces and tap Start Puzzle.";
          startBtn.disabled = false;
          resetBtn.disabled = false;
          setStatus("Picture ready. Tap Start Puzzle.");
        };
        previewImg.onerror = function() {
          previewBox.innerHTML = '<span style="font-size:0.85rem;color:#b91c1c;text-align:center;padding:8px;">Preview issue, but you can still try Start Puzzle.</span>';
          startBtn.disabled = false;
          resetBtn.disabled = false;
          setStatus("Preview issue, but puzzle may still work. Tap Start Puzzle.");
        };
        previewImg.src = imageDataUrl;
      };
      baseImg.onerror = function() {
        previewBox.innerHTML = '<span style="font-size:0.85rem;color:#b91c1c;text-align:center;padding:8px;">Picture could not be loaded. Try a JPEG or PNG photo.</span>';
        previewLabel.textContent = "Picture could not be loaded.";
        setStatus("Picture could not be loaded. Try a different photo.");
      };
      baseImg.src = originalDataUrl;
    };

    reader.onerror = function() {
      previewBox.innerHTML = '<span style="font-size:0.85rem;color:#b91c1c;text-align:center;padding:8px;">Could not read that file. Please try again.</span>';
      previewLabel.textContent = "Could not read that file.";
      setStatus("Could not read that file. Try again.");
    };

    reader.readAsDataURL(file);
  });

  function buildTiles() {
    if (!imageDataUrl) {
      showToast("Choose a picture first.");
      return;
    }
    tilesLayer.innerHTML = "";
    tiles = [];
    moves = 0;
    updateMovesLabel();

    tilesLayer.style.gridTemplateRows = "repeat(" + rows + ", 1fr)";
    tilesLayer.style.gridTemplateColumns = "repeat(" + cols + ", 1fr)";

    const total = rows * cols;
    for (let i = 0; i < total; i++) {
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.dataset.index = i;
      tile.dataset.currentIndex = i;

      const img = document.createElement("img");
      img.src = imageDataUrl;

      const rIndex = Math.floor(i / cols);
      const cIndex = i % cols;
      const xPercent = (cols === 1) ? 50 : (cIndex / (cols - 1)) * 100;
      const yPercent = (rows === 1) ? 50 : (rIndex / (rows - 1)) * 100;
      img.style.objectPosition = xPercent + "% " + yPercent + "%";

      tile.appendChild(img);
      tile.addEventListener("click", function() {
        handleTileClick(i);
      });

      tilesLayer.appendChild(tile);
      tiles.push({ index: i, currentIndex: i, element: tile });
    }

    updateTilesVisualState();
  }

  function shuffleTiles() {
    if (!tiles.length) return;
    const order = tiles.map(function(_, idx) { return idx; });
    for (let i = order.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const temp = order[i];
      order[i] = order[j];
      order[j] = temp;
    }
    tiles.forEach(function(tileObj, i) {
      tileObj.currentIndex = order[i];
      tileObj.element.dataset.currentIndex = order[i];
    });
    moves = 0;
    updateMovesLabel();
    firstSelectedIndex = null;
    updateTilesVisualState();
    setStatus("Tap one tile, then another, to swap them.");
  }

  function handleTileClick(solvedIndex) {
    const tileObj = tiles.find(function(t) { return t.index === solvedIndex; });
    if (!tileObj) return;

    if (firstSelectedIndex === null) {
      firstSelectedIndex = solvedIndex;
      highlightSelected();
      return;
    }

    if (firstSelectedIndex === solvedIndex) {
      firstSelectedIndex = null;
      highlightSelected();
      return;
    }

    const otherTile = tiles.find(function(t) { return t.index === firstSelectedIndex; });
    if (!otherTile) {
      firstSelectedIndex = null;
      highlightSelected();
      return;
    }

    const temp = tileObj.currentIndex;
    tileObj.currentIndex = otherTile.currentIndex;
    otherTile.currentIndex = temp;
    tileObj.element.dataset.currentIndex = tileObj.currentIndex;
    otherTile.element.dataset.currentIndex = otherTile.currentIndex;

    moves++;
    updateMovesLabel();
    firstSelectedIndex = null;
    highlightSelected();
    updateTilesVisualState();
    checkSolved();
  }

  function highlightSelected() {
    tiles.forEach(function(t) {
      t.element.style.boxShadow = "";
      t.element.style.transform = "";
    });
    if (firstSelectedIndex === null) return;
    const selected = tiles.find(function(t) { return t.index === firstSelectedIndex; });
    if (selected) {
      selected.element.style.boxShadow = "0 0 0 3px rgba(59,130,246,0.9)";
      selected.element.style.transform = "translateY(-1px)";
    }
  }

  function updateTilesVisualState() {
    tiles.forEach(function(t) {
      if (t.index === t.currentIndex) {
        t.element.classList.add("correct");
      } else {
        t.element.classList.remove("correct");
      }
    });
  }

  function checkSolved() {
    if (!tiles.length) return;
    const allCorrect = tiles.every(function(t) { return t.index === t.currentIndex; });
    if (allCorrect) {
      setStatus("Solved! ðŸŽ‰");
      doneOverlay.style.display = "flex";
    }
  }

  startBtn.addEventListener("click", function() {
    if (!imageDataUrl) {
      showToast("Choose a picture first.");
      return;
    }
    parsePreset(presetSelect.value);
    buildTiles();
    shuffleTiles();
    shuffleBtn.disabled = false;
    resetBtn.disabled = false;
  });

  shuffleBtn.addEventListener("click", function() {
    shuffleTiles();
  });

  resetBtn.addEventListener("click", function() {
    if (!imageDataUrl) return;
    buildTiles();
    setStatus("Showing the original order. Tap Shuffle to play again.");
  });

  doneClose.addEventListener("click", function() {
    doneOverlay.style.display = "none";
  });

  doneShuffle.addEventListener("click", function() {
    doneOverlay.style.display = "none";
    shuffleTiles();
  });

  // Initialize defaults
  parsePreset(presetSelect.value);
  updateMovesLabel();
  setStatus("Upload a picture to begin.");
</script>
</body>
</html>

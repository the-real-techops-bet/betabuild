<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Activity Adventure Map v0.9.1 ‚Äì School Day & Weekend</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle at top, #fef9c3 0, #bbf7d0 30%, #e0f2fe 70%, #f1f5f9 100%);
  }
  .app {
    background: #fff9e6;
    width: 100%;
    max-width: 820px;
    margin: 10px;
    padding: 18px 16px 22px;
    border-radius: 24px;
    box-shadow: 0 18px 42px rgba(15, 23, 42, 0.32);
    position: relative;
    overflow: hidden;
    border: 3px solid #fcd34d;
  }
  .app::before {
    content: "";
    position: absolute;
    inset: -40px;
    background:
      radial-gradient(circle at 10% 0, rgba(34, 197, 94, 0.16), transparent 60%),
      radial-gradient(circle at 90% 0, rgba(56, 189, 248, 0.18), transparent 55%);
    pointer-events: none;
    z-index: -1;
  }

  /* Splash Mode Selector */
  .splash {
    position: absolute;
    inset: 0;
    background: #fff9e6;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 18px;
    text-align: center;
    z-index: 60;
  }
  .splash-mascot {
    width: 230px;
    height: 230px;
    margin-bottom: 12px;
  }
  .splash h1 {
    margin: 4px 0 6px;
    font-size: 1.6rem;
    color: #111827;
  }
  .splash p {
    margin: 4px 0 14px;
    font-size: 0.96rem;
    color: #4b5563;
    max-width: 360px;
  }
  .mode-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 420px;
    margin-top: 4px;
  }
  .mode-btn {
    border-radius: 26px;
    border: none;
    padding: 16px 22px;
    font-size: 1.3rem;
    font-weight: 800;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 10px 26px rgba(15, 23, 42, 0.35);
  }
  .mode-btn span {
    font-size: 1.7rem;
  }
  .mode-btn-school {
    background: linear-gradient(135deg, #1d4ed8, #3b82f6);
    color: #eff6ff;
    border: 2px solid #bfdbfe;
  }
  .mode-btn-weekend {
    background: linear-gradient(135deg, #f97316, #ec4899);
    color: #fef9c3;
    border: 2px solid #fed7aa;
  }
  .splash-sub {
    font-size: 0.78rem;
    color: #9ca3af;
    max-width: 280px;
    margin-top: 12px;
  }

  /* Mode tag */
  .mode-tag {
    font-size: 0.8rem;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
  }
  .mode-tag span {
    font-size: 1rem;
  }
  .mode-tag-school {
    background: #dbeafe;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
  }
  .mode-tag-weekend {
    background: #ffedd5;
    color: #c2410c;
    border: 1px solid #fed7aa;
  }

  /* Banner */
  .banner {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 18px;
    margin-bottom: 8px;
    position: relative;
    overflow: hidden;
  }
  .banner-school {
    background: linear-gradient(135deg, #2563eb, #0ea5e9);
  }
  .banner-weekend {
    background: linear-gradient(135deg, #22c55e, #f97316);
  }
  .banner-mascot {
    width: 62px;
    height: 62px;
    flex-shrink: 0;
  }
  .banner-text h1 {
    margin: 0;
    font-size: 1.28rem;
    color: #fefce8;
  }
  .banner-text p {
    margin: 2px 0 0;
    font-size: 0.86rem;
    color: #fef9c3;
  }
  .banner::after {
    content: "‚ú®";
    position: absolute;
    right: 10px;
    top: 6px;
    font-size: 1.9rem;
    opacity: 0.35;
  }

  .subtitle {
    text-align: center;
    font-size: 0.9rem;
    color: #4b5563;
    margin: 6px 0 10px;
  }

  #file-input {
    display: none;
  }
  .upload-label {
    display: block;
    text-align: center;
    background: linear-gradient(135deg, #9b5de5, #ec4899);
    color: #fefce8;
    padding: 10px 18px;
    border-radius: 999px;
    width: fit-content;
    margin: 0 auto 4px;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.95rem;
    box-shadow: 0 8px 20px rgba(147, 51, 234, 0.6);
    border: 2px solid #f9a8d4;
  }
  .upload-label span {
    margin-right: 4px;
  }
  .small-note {
    text-align: center;
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 10px;
  }

  .layout {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .pile,
  .slots-wrapper {
    flex: 1 1 320px;
    min-width: 0;
  }
  .section-title {
    font-size: 0.9rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .section-title span {
    font-size: 1rem;
  }

  #pile-area {
    min-height: 190px;
    border-radius: 18px;
    padding: 10px;
    border: 2px dashed #bfdbfe;
    background: linear-gradient(135deg, #e0f2fe, #dcfce7);
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }

  /* 4:3 pieces */
  .piece {
    width: 180px;
    height: 135px;
    border-radius: 16px;
    overflow: hidden;
    cursor: grab;
    background: #e5e7eb;
    position: relative;
    box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
    border: 2px solid rgba(15, 23, 42, 0.05);
    transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
  }
  .piece img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    pointer-events: none;
  }
  .piece.selected {
    border-color: #22c55e;
    transform: scale(1.04);
    box-shadow: 0 0 0 2px #bbf7d0, 0 8px 18px rgba(22, 163, 74, 0.5);
  }

  .slots-wrapper {
    margin-top: 4px;
  }
  .slots-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .slot-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .slot-label {
    width: 84px;
    min-width: 84px;
    font-size: 0.82rem;
    color: #fefce8;
    background: linear-gradient(135deg, #2563eb, #9333ea);
    border-radius: 999px;
    padding: 5px 8px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(79, 70, 229, 0.5);
    border: 1px solid #ede9fe;
    display: flex;
    flex-direction: column;
    gap: 1px;
    align-items: center;
  }
  .slot-label strong {
    font-size: 0.86rem;
  }
  .slot-label span {
    font-size: 0.72rem;
  }
  .slot-label .icon {
    font-size: 1rem;
  }

  /* 4:3 slots */
  .slot {
    flex: 1;
    height: 135px;
    border-radius: 20px;
    border: 3px solid #fed7aa;
    background: #fef3c7;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: stretch;
    justify-content: stretch;
    transition: transform 0.1s ease, box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease;
  }
  .slot.is-first {
    border-color: #22c55e;
    background: #dcfce7;
  }
  .slot.is-last {
    border-color: #f97316;
    background: #ffedd5;
  }
  .slot.empty::before {
    content: "Drop or tap here";
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: #9ca3af;
    pointer-events: none;
  }
  .slot.highlight {
    transform: scale(1.03);
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.45);
    border-color: #22c55e;
    background: #ecfccb;
  }
  .slot .piece {
    width: 100%;
    height: 100%;
    border-radius: 16px;
    box-shadow: none;
    border-width: 0;
  }

  .helper-text {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 4px;
  }
  .helper-text strong {
    color: #111827;
  }

  .bottom-bar {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
  }
  .btn {
    border-radius: 999px;
    border: none;
    padding: 8px 14px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }
  .btn-primary {
    background: linear-gradient(135deg, #16a34a, #22c55e);
    color: #fefce8;
    box-shadow: 0 4px 12px rgba(22, 163, 74, 0.7);
  }
  .btn-secondary {
    background: #e0f2fe;
    color: #0f172a;
    border: 1px solid #bae6fd;
  }
  .btn-danger {
    background: #fee2e2;
    color: #b91c1c;
    border: 1px solid #fecaca;
  }
  .btn:disabled {
    opacity: 0.55;
    cursor: default;
    box-shadow: none;
  }

  .results {
    margin-top: 8px;
    font-size: 0.8rem;
    color: #111827;
    background: #eff6ff;
    border-radius: 10px;
    padding: 8px 10px;
    max-height: 160px;
    overflow-y: auto;
    display: none;
    border: 1px solid #bfdbfe;
  }
  .results strong {
    font-size: 0.85rem;
  }

  .toast {
    position: fixed;
    left: 50%;
    bottom: 14px;
    transform: translateX(-50%);
    background: rgba(15, 23, 42, 0.94);
    color: #f9fafb;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.78rem;
    display: none;
    z-index: 999;
  }
  .toast.show {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    animation: fadeToast 2s ease-out forwards;
  }
  @keyframes fadeToast {
    0% { opacity: 0; transform: translate(-50%, 4px); }
    10% { opacity: 1; transform: translate(-50%, 0); }
    80% { opacity: 1; transform: translate(-50%, 0); }
    100% { opacity: 0; transform: translate(-50%, 4px); }
  }

  .sparkle {
    position: absolute;
    font-size: 1.6rem;
    pointer-events: none;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(0.2);
    opacity: 0;
    animation: sparklePop 0.6s ease-out forwards;
  }
  @keyframes sparklePop {
    0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
    30% { transform: translate(-50%, -52%) scale(1); opacity: 1; }
    100% { transform: translate(-50%, -60%) scale(0.8); opacity: 0; }
  }

  .overlay {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.38);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 40;
  }
  .overlay-content {
    background: #ffffff;
    border-radius: 18px;
    padding: 14px 14px 12px;
    width: 90%;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 16px 50px rgba(15, 23, 42, 0.65);
  }
  .overlay-content h2 {
    font-size: 1.1rem;
    margin: 4px 0;
    color: #111827;
  }
  .overlay-content p {
    font-size: 0.9rem;
    color: #4b5563;
    margin: 4px 0 10px;
  }
  .overlay-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 6px;
  }

  .export-note {
    font-size: 0.76rem;
    color: #6b7280;
    margin-top: 4px;
    text-align: right;
  }

  .hidden {
    display: none !important;
  }

  @media (max-width: 640px) {
    .layout { flex-direction: column; }
    .slot-label { width: 76px; min-width: 76px; }
    .piece, .slot { width: 100%; height: 140px; }
    .mode-buttons { gap: 10px; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Splash Mode Selector -->
  <div id="splash" class="splash">
    <svg class="splash-mascot" viewBox="0 0 200 200" aria-hidden="true">
      <defs>
        <radialGradient id="sunGradSplash" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#fef9c3"/>
          <stop offset="60%" stop-color="#facc15"/>
          <stop offset="100%" stop-color="#f97316"/>
        </radialGradient>
        <linearGradient id="rainbowGradSplash" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#ec4899"/>
          <stop offset="30%" stop-color="#f97316"/>
          <stop offset="60%" stop-color="#facc15"/>
          <stop offset="100%" stop-color="#22c55e"/>
        </linearGradient>
      </defs>
      <!-- Rainbow arc -->
      <path d="M20 130 Q100 40 180 130" fill="none" stroke="url(#rainbowGradSplash)" stroke-width="20" stroke-linecap="round"/>
      <path d="M35 130 Q100 55 165 130" fill="none" stroke="#bfdbfe" stroke-width="10" stroke-linecap="round" opacity="0.7"/>
      <!-- Sun -->
      <circle cx="60" cy="70" r="32" fill="url(#sunGradSplash)" />
      <!-- Sun face -->
      <circle cx="50" cy="65" r="5" fill="#f97316"/>
      <circle cx="70" cy="65" r="5" fill="#f97316"/>
      <path d="M50 80 Q60 90 70 80" stroke="#f97316" stroke-width="3" fill="none" stroke-linecap="round"/>
      <!-- Clouds -->
      <g fill="#f9fafb" stroke="#d1d5db" stroke-width="1.5">
        <path d="M30 135 q10-10 20 0 q10-5 18 6 q-4 9-18 9 h-20 q-10 0-13-6 q3-8 13-9z"/>
        <path d="M135 130 q10-10 20 0 q10-5 18 6 q-4 9-18 9 h-20 q-10 0-13-6 q3-8 13-9z"/>
      </g>
    </svg>
    <h1>Choose Today‚Äôs Adventure</h1>
    <p>Pick which kind of day it is. Then she can use pictures to build the path from <strong>FIRST</strong> to <strong>LAST</strong>.</p>
    <div class="mode-buttons">
      <button id="mode-school" class="mode-btn mode-btn-school" type="button">
        <span>üöå</span> School Day
      </button>
      <button id="mode-weekend" class="mode-btn mode-btn-weekend" type="button">
        <span>üéâ</span> Weekend
      </button>
    </div>
    <div class="splash-sub">
      Tip: You can come back and choose the other mode later. Each mode remembers its own pictures and puzzle.
    </div>
  </div>

  <!-- Mode tag -->
  <div id="modeTag" class="mode-tag mode-tag-school hidden">
    <span id="modeTagIcon">üöå</span><span id="modeTagText">School Day</span>
  </div>

  <!-- Banner -->
  <div id="banner" class="banner banner-school">
    <svg class="banner-mascot" viewBox="0 0 200 200" aria-hidden="true">
      <defs>
        <radialGradient id="sunGradSmall" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stop-color="#fef9c3"/>
          <stop offset="60%" stop-color="#facc15"/>
          <stop offset="100%" stop-color="#f97316"/>
        </radialGradient>
      </defs>
      <circle cx="55" cy="80" r="26" fill="url(#sunGradSmall)" />
      <circle cx="48" cy="75" r="4" fill="#f97316"/>
      <circle cx="62" cy="75" r="4" fill="#f97316"/>
      <path d="M48 87 Q55 94 62 87" stroke="#f97316" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      <path d="M30 120 Q55 70 100 120" fill="none" stroke="#f9a8d4" stroke-width="10" stroke-linecap="round"/>
    </svg>
    <div class="banner-text">
      <h1 id="bannerTitle">School Day Adventure Map</h1>
      <p id="bannerSub">Help her choose what happens from getting ready to the last thing before quiet time.</p>
    </div>
  </div>

  <p id="subtitle" class="subtitle">
    Upload photos, then drag or tap them into the boxes from 1 (FIRST) ‚Üí 5 (LAST). She can change her mind anytime.
  </p>

  <label class="upload-label" for="file-input">
    <span>üì∑</span> Add pictures
  </label>
  <input id="file-input" type="file" accept="image/*" multiple />
  <div class="small-note">
    Up to about 5‚Äì10 photos per mode works best. Pieces left in the backpack pile can mean ‚Äúnot today.‚Äù
  </div>

  <div class="layout">
    <section class="pile">
      <div class="section-title">
        <span>üéí</span> Backpack pieces
      </div>
      <div id="pile-area"></div>
      <div class="helper-text">
        <strong>How:</strong> Tap a picture once to select it (green glow), then tap a box. Or drag it like a puzzle piece. Tap a picture in a box to send it back to the backpack.
      </div>
    </section>

    <section class="slots-wrapper">
      <div class="section-title">
        <span>üó∫Ô∏è</span> Steps on the path (1 = FIRST, 5 = LAST)
      </div>
      <div id="slots-grid" class="slots-grid"></div>
      <div class="export-note">
        Export the boxes as an image for her visual schedule.
      </div>
    </section>
  </div>

  <div class="bottom-bar">
    <div style="font-size:0.8rem;color:#6b7280;max-width:60%;">
      When she is happy with the order, tap <strong>Save order</strong> for a text list, or <strong>Export image</strong> to download the map picture.
    </div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button id="start-over" class="btn btn-danger" type="button">Start Over (This Mode)</button>
      <button id="reset-puzzle" class="btn btn-secondary" type="button">Reset to Backpack</button>
      <button id="export-btn" class="btn btn-secondary" type="button" disabled>Export image</button>
      <button id="save-btn" class="btn btn-primary" type="button" disabled>Save order</button>
    </div>
  </div>

  <div id="results" class="results"></div>

  <div id="confirm-overlay" class="overlay">
    <div class="overlay-content">
      <h2>All done with today‚Äôs path?</h2>
      <p>Is she finished choosing what she wants to do from <strong>FIRST</strong> to <strong>LAST</strong>?</p>
      <div class="overlay-buttons">
        <button id="confirm-no" class="btn btn-secondary" type="button">Keep exploring</button>
        <button id="confirm-yes" class="btn btn-primary" type="button">Yes, show the list</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Saved</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" integrity="sha256-yM+MiN6KDAdAm8YGtS+wGGyRyvE4s46HoPazTA/gkGk=" crossorigin="anonymous"></script>
<script>
  const STORAGE_KEY = "activityAdventure_v0_9_1_dualMode";
  const MODES = ["school", "weekend"];

  const splash = document.getElementById("splash");
  const modeSchoolBtn = document.getElementById("mode-school");
  const modeWeekendBtn = document.getElementById("mode-weekend");

  const modeTag = document.getElementById("modeTag");
  const modeTagIcon = document.getElementById("modeTagIcon");
  const modeTagText = document.getElementById("modeTagText");
  const banner = document.getElementById("banner");
  const bannerTitle = document.getElementById("bannerTitle");
  const bannerSub = document.getElementById("bannerSub");
  const subtitleEl = document.getElementById("subtitle");

  const fileInput = document.getElementById("file-input");
  const pileArea = document.getElementById("pile-area");
  const slotsGrid = document.getElementById("slots-grid");

  const saveBtn = document.getElementById("save-btn");
  const resetBtn = document.getElementById("reset-puzzle");
  const startOverBtn = document.getElementById("start-over");
  const exportBtn = document.getElementById("export-btn");
  const resultsBox = document.getElementById("results");
  const toast = document.getElementById("toast");
  const confirmOverlay = document.getElementById("confirm-overlay");
  const confirmYes = document.getElementById("confirm-yes");
  const confirmNo = document.getElementById("confirm-no");

  let state = {
    school: { pieces: [], slots: [null, null, null, null, null] },
    weekend: { pieces: [], slots: [null, null, null, null, null] }
  };
  let currentMode = "school";
  let selectedPieceId = null;

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {
      console.warn("Could not save state", e);
    }
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (!parsed) return;
      MODES.forEach(m => {
        if (parsed[m]) {
          if (Array.isArray(parsed[m].pieces)) state[m].pieces = parsed[m].pieces;
          if (Array.isArray(parsed[m].slots) && parsed[m].slots.length === 5) {
            state[m].slots = parsed[m].slots;
          }
        }
      });
    } catch (e) {
      console.warn("Could not load state", e);
    }
  }

  function applyModeTheme() {
    modeTag.classList.remove("mode-tag-school", "mode-tag-weekend");
    banner.classList.remove("banner-school", "banner-weekend");

    if (currentMode === "school") {
      modeTag.classList.add("mode-tag-school");
      banner.classList.add("banner-school");
      modeTagIcon.textContent = "üöå";
      modeTagText.textContent = "School Day";
      bannerTitle.textContent = "School Day Adventure Map";
      bannerSub.textContent = "Help her choose what happens from getting ready to the last thing before quiet time.";
      subtitleEl.textContent = "Upload photos for school routines, then drag or tap them into the boxes from 1 (FIRST) ‚Üí 5 (LAST). She can change her mind anytime.";
    } else {
      modeTag.classList.add("mode-tag-weekend");
      banner.classList.add("banner-weekend");
      modeTagIcon.textContent = "üéâ";
      modeTagText.textContent = "Weekend";
      bannerTitle.textContent = "Weekend Adventure Map";
      bannerSub.textContent = "Help her choose fun activities for today, from the very first thing to the last.";
      subtitleEl.textContent = "Upload photos for home or fun activities, then drag or tap them into the boxes from 1 (FIRST) ‚Üí 5 (LAST). She can change her mind anytime.";
    }
  }

  function selectMode(mode) {
    currentMode = mode;
    splash.classList.add("hidden");
    modeTag.classList.remove("hidden");
    applyModeTheme();
    renderAll();
  }

  function attachModeButtonHandlers() {
    function handlerSchool(e) {
      e.preventDefault();
      selectMode("school");
    }
    function handlerWeekend(e) {
      e.preventDefault();
      selectMode("weekend");
    }

    modeSchoolBtn.addEventListener("click", handlerSchool);
    modeWeekendBtn.addEventListener("click", handlerWeekend);

    // Touch-friendly for some mobile browsers
    modeSchoolBtn.addEventListener("touchstart", handlerSchool, { passive: true });
    modeWeekendBtn.addEventListener("touchstart", handlerWeekend, { passive: true });
  }

  function buildSlotsGrid() {
    slotsGrid.innerHTML = "";
    const labelsSchool = [
      { text: "1", sub: "FIRST", icon: "üåû" },
      { text: "2", sub: "Next", icon: "üßÉ" },
      { text: "3", sub: "", icon: "üìù" },
      { text: "4", sub: "", icon: "üéí" },
      { text: "5", sub: "LAST", icon: "üåô" }
    ];
    const labelsWeekend = [
      { text: "1", sub: "FIRST", icon: "üåû" },
      { text: "2", sub: "Next", icon: "üéÆ" },
      { text: "3", sub: "", icon: "üèûÔ∏è" },
      { text: "4", sub: "", icon: "üçø" },
      { text: "5", sub: "LAST", icon: "üåà" }
    ];
    const labels = currentMode === "school" ? labelsSchool : labelsWeekend;

    for (let i = 0; i < 5; i++) {
      const row = document.createElement("div");
      row.className = "slot-row";

      const label = document.createElement("div");
      label.className = "slot-label";
      const lab = labels[i];
      label.innerHTML = `
        <div class="icon">${lab.icon}</div>
        <strong>${lab.text}</strong>
        <span>${lab.sub || ""}</span>
      `;

      const slot = document.createElement("div");
      slot.className = "slot";
      if (i === 0) slot.classList.add("is-first");
      if (i === 4) slot.classList.add("is-last");
      slot.dataset.index = i;

      slot.addEventListener("click", () => {
        if (selectedPieceId) {
          placeSelectedInSlot(i);
        }
      });

      slot.addEventListener("dragover", (e) => {
        e.preventDefault();
        slot.classList.add("highlight");
      });

      slot.addEventListener("dragleave", () => {
        slot.classList.remove("highlight");
      });

      slot.addEventListener("drop", (e) => {
        e.preventDefault();
        slot.classList.remove("highlight");
        const id = e.dataTransfer.getData("text/plain") || selectedPieceId;
        if (!id) return;
        const piece = state[currentMode].pieces.find(p => p.id === id);
        if (!piece) return;
        state[currentMode].slots[i] = id;
        selectedPieceId = null;
        saveState();
        renderAll();
        showSparkle(slot);
      });

      row.appendChild(label);
      row.appendChild(slot);
      slotsGrid.appendChild(row);
    }
  }

  function createPieceElement(piece) {
    const div = document.createElement("div");
    div.className = "piece";
    div.draggable = true;
    div.dataset.id = piece.id;
    div.innerHTML = `<img src="${piece.dataUrl}" alt="activity">`;

    div.addEventListener("click", () => {
      const inSlotIndex = state[currentMode].slots.indexOf(piece.id);
      if (inSlotIndex !== -1 && !selectedPieceId) {
        state[currentMode].slots[inSlotIndex] = null;
        saveState();
        renderAll();
        return;
      }
      if (selectedPieceId === piece.id) {
        selectedPieceId = null;
      } else {
        selectedPieceId = piece.id;
      }
      updateSelectionHighlight();
    });

    div.addEventListener("dragstart", (e) => {
      selectedPieceId = piece.id;
      updateSelectionHighlight();
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", piece.id);
    });

    return div;
  }

  function updateSelectionHighlight() {
    const allPieces = document.querySelectorAll(".piece");
    allPieces.forEach(el => {
      el.classList.toggle("selected", el.dataset.id === String(selectedPieceId));
    });
  }

  function renderAll() {
    buildSlotsGrid();

    const { pieces, slots } = state[currentMode];

    pileArea.innerHTML = "";
    pieces.forEach(p => {
      if (!slots.includes(p.id)) {
        const el = createPieceElement(p);
        pileArea.appendChild(el);
      }
    });

    const slotDivs = Array.from(document.querySelectorAll(".slot"));
    slotDivs.forEach((slotEl, idx) => {
      slotEl.innerHTML = "";
      slotEl.classList.add("empty");
      const id = slots[idx];
      if (id) {
        const piece = pieces.find(p => p.id === id);
        if (piece) {
          const el = createPieceElement(piece);
          slotEl.appendChild(el);
          slotEl.classList.remove("empty");
        }
      }
    });

    const hasAny = pieces.length > 0;
    saveBtn.disabled = !hasAny;
    exportBtn.disabled = !hasAny;
    resultsBox.style.display = "none";
    updateSelectionHighlight();
  }

  function placeSelectedInSlot(slotIndex) {
    if (!selectedPieceId) return;
    const pieceExists = state[currentMode].pieces.find(p => p.id === selectedPieceId);
    if (!pieceExists) return;
    const prevIndex = state[currentMode].slots.indexOf(selectedPieceId);
    if (prevIndex !== -1) {
      state[currentMode].slots[prevIndex] = null;
    }
    state[currentMode].slots[slotIndex] = selectedPieceId;
    selectedPieceId = null;
    saveState();
    renderAll();
    const slotEl = slotsGrid.querySelector('.slot[data-index="' + slotIndex + '"]');
    if (slotEl) showSparkle(slotEl);
  }

  function showSparkle(slotEl) {
    const sp = document.createElement("div");
    sp.className = "sparkle";
    sp.textContent = "‚ú®";
    slotEl.appendChild(sp);
    setTimeout(() => sp.remove(), 650);
  }

  pileArea.addEventListener("dragover", (e) => {
    e.preventDefault();
  });
  pileArea.addEventListener("drop", (e) => {
    e.preventDefault();
    const id = e.dataTransfer.getData("text/plain") || selectedPieceId;
    if (!id) return;
    const idx = state[currentMode].slots.indexOf(id);
    if (idx !== -1) {
      state[currentMode].slots[idx] = null;
      selectedPieceId = null;
      saveState();
      renderAll();
    }
  });

  fileInput.addEventListener("change", (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    const currentPieces = state[currentMode].pieces;
    const remainingSlots = Math.max(0, 10 - currentPieces.length);
    const chosen = files.slice(0, remainingSlots || 0);
    if (!chosen.length) {
      showToast("Backpack is full for this mode (limit reached)");
      fileInput.value = "";
      return;
    }

    let loadedCount = 0;
    chosen.forEach(file => {
      if (!file.type.startsWith("image/")) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        const dataUrl = evt.target.result;
        currentPieces.push({
          id: Date.now().toString() + Math.random().toString(16).slice(2),
          dataUrl
        });
        loadedCount++;
        if (loadedCount === chosen.length) {
          saveState();
          renderAll();
          showToast("Added " + loadedCount + " picture" + (loadedCount > 1 ? "s" : "") + " to " + (currentMode === "school" ? "School Day" : "Weekend"));
        }
      };
      reader.onerror = () => {
        console.warn("Error reading file");
      };
      reader.readAsDataURL(file);
    });

    fileInput.value = "";
  });

  resetBtn.addEventListener("click", () => {
    const { pieces, slots } = state[currentMode];
    if (!pieces.length && slots.every(x => !x)) return;
    state[currentMode].slots = [null, null, null, null, null];
    selectedPieceId = null;
    saveState();
    renderAll();
    showToast("All pieces back to backpack (" + (currentMode === "school" ? "School Day" : "Weekend") + ")");
  });

  startOverBtn.addEventListener("click", () => {
    const { pieces, slots } = state[currentMode];
    if (!pieces.length && slots.every(x => !x)) return;
    if (confirm("Start completely over and remove all pictures for this mode?")) {
      state[currentMode].pieces = [];
      state[currentMode].slots = [null, null, null, null, null];
      selectedPieceId = null;
      saveState();
      renderAll();
      showToast("Adventure reset for " + (currentMode === "school" ? "School Day" : "Weekend"));
    }
  });

  saveBtn.addEventListener("click", () => {
    const { pieces } = state[currentMode];
    if (!pieces.length) return;
    confirmOverlay.style.display = "flex";
  });

  confirmNo.addEventListener("click", () => {
    confirmOverlay.style.display = "none";
  });

  confirmYes.addEventListener("click", () => {
    confirmOverlay.style.display = "none";
    showResults();
  });

  function showResults() {
    const { pieces, slots } = state[currentMode];
    const lines = [];
    slots.forEach((id, idx) => {
      if (!id) return;
      const pieceIndex = pieces.findIndex(p => p.id === id);
      const label = "Picture " + (pieceIndex + 1);
      let tag = "";
      if (idx === 0) tag = " (FIRST)";
      else if (idx === slots.length - 1) tag = " (LAST)";
      lines.push((idx + 1) + ". " + label + tag);
    });
    resultsBox.style.display = "block";
    if (!lines.length) {
      resultsBox.innerHTML = "<strong>No boxes filled yet for this mode.</strong>";
      return;
    }
    resultsBox.innerHTML = "<strong>Order for " + (currentMode === "school" ? "School Day" : "Weekend") + " (copy or screenshot):</strong>" +
      lines.map(l => `<div>${l}</div>`).join("");
    resultsBox.scrollTop = 0;
    showToast("Order saved");
  }

  exportBtn.addEventListener("click", async () => {
    const { pieces } = state[currentMode];
    if (!pieces.length) return;
    if (typeof html2canvas === "undefined") {
      showToast("Export not available");
      return;
    }
    try {
      const canvas = await html2canvas(slotsGrid, {
        backgroundColor: "#ffffff",
        scale: window.devicePixelRatio > 1 ? 2 : 1
      });
      const dataUrl = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.href = dataUrl;
      link.download = (currentMode === "school" ? "school-day" : "weekend") + "-activity-map.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showToast("Image downloaded");
    } catch (e) {
      console.error(e);
      showToast("Could not export image");
    }
  });

  function init() {
    loadState();
    applyModeTheme();
    renderAll();
    attachModeButtonHandlers();
  }

  window.addEventListener("load", init);
</script>
</body>
</html>

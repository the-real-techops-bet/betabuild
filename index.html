<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Japanese Quest ‚Äì Sound & FX Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #c7d2fe 0, #eef2ff 45%, #e5e7eb 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .app {
      background: #ffffff;
      width: 100%;
      max-width: 520px;
      padding: 22px 20px 26px;
      border-radius: 22px;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
      position: relative;
      overflow: hidden;
    }
    .app::before {
      content: "";
      position: absolute;
      inset: -40px;
      background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.12), transparent 60%);
      pointer-events: none;
      z-index: -1;
    }
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .mascot {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fef3c7, #ea580c);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(248, 165, 66, 0.6);
      position: relative;
      overflow: hidden;
    }
    .mascot-face {
      font-size: 30px;
      transform: translateY(2px);
    }
    .mascot-ear {
      position: absolute;
      width: 22px;
      height: 22px;
      background: #f97316;
      transform: rotate(45deg);
      top: -7px;
    }
    .mascot-ear.left { left: 4px; }
    .mascot-ear.right { right: 4px; }
    .title-block h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #1e1b4b;
    }
    .title-block .subtitle {
      margin: 0;
      font-size: 0.85rem;
      color: #6b7280;
    }
    .xp-bar-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0 10px;
    }
    .xp-label {
      font-size: 0.8rem;
      color: #4b5563;
      white-space: nowrap;
    }
    .xp-bar {
      flex: 1;
      height: 9px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }
    .xp-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.25s ease;
    }
    .xp-floater {
      position: absolute;
      right: 8px;
      top: -18px;
      font-size: 0.75rem;
      font-weight: 700;
      color: #16a34a;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
    }
    .xp-floater.show {
      opacity: 1;
      transform: translateY(-4px);
    }
    .progress-wrapper {
      background: #e5e7eb;
      border-radius: 999px;
      height: 9px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #6366f1, #22c55e);
      transition: width 0.25s ease;
    }
    .progress-text {
      text-align: right;
      font-size: 0.78rem;
      color: #4b5563;
      margin-bottom: 10px;
    }
    .question-box {
      background: #f9fafb;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
    }
    .question-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 3px;
    }
    .question-text {
      font-size: 0.96rem;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .prompt-text {
      font-size: 1.35rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    .direction-text {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .options {
      display: grid;
      gap: 8px;
      margin-bottom: 10px;
    }
    .option-btn {
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      text-align: left;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, transform 0.08s, box-shadow 0.15s;
      position: relative;
      overflow: hidden;
    }
    .option-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(129, 140, 248, 0.2), transparent 60%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .option-btn:active::after {
      opacity: 1;
    }
    .option-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.12);
      border-color: #9ca3af;
      background: #eef2ff;
    }
    .option-btn.correct {
      background: #dcfce7;
      border-color: #16a34a;
    }
    .option-btn.wrong {
      background: #fee2e2;
      border-color: #dc2626;
    }
    .option-btn.disabled {
      pointer-events: none;
      opacity: 0.85;
    }
    .feedback {
      font-size: 0.9rem;
      min-height: 1.3em;
      margin-bottom: 10px;
    }
    .feedback.correct {
      color: #16a34a;
      font-weight: 600;
    }
    .feedback.wrong {
      color: #dc2626;
      font-weight: 600;
    }
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .score-text {
      font-size: 0.9rem;
      color: #111827;
      font-weight: 600;
    }
    .score-text small {
      display: block;
      font-size: 0.72rem;
      color: #6b7280;
      font-weight: 400;
    }
    .primary-btn {
      border: none;
      border-radius: 12px;
      padding: 9px 18px;
      background: linear-gradient(135deg, #4f46e5, #22c55e);
      color: #ffffff;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 6px 16px rgba(79, 70, 229, 0.45);
      transition: transform 0.08s, box-shadow 0.15s, filter 0.15s;
      white-space: nowrap;
    }
    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(79, 70, 229, 0.5);
      filter: brightness(1.05);
    }
    .primary-btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow: none;
      filter: none;
    }
    .summary {
      text-align: center;
      margin-top: 12px;
      display: none;
    }
    .summary h2 {
      margin-bottom: 4px;
      font-size: 1.25rem;
      color: #1f2937;
    }
    .summary p {
      margin: 2px 0;
      font-size: 0.9rem;
      color: #4b5563;
    }
    .badge {
      display: inline-block;
      background: #eef2ff;
      color: #4338ca;
      padding: 3px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .difficulty-tag {
      font-size: 0.78rem;
      color: #0f766e;
      background: #ccfbf1;
      border-radius: 999px;
      padding: 2px 8px;
      display: inline-block;
      margin-left: 4px;
      vertical-align: middle;
    }
    .confetti-piece {
      position: fixed;
      width: 9px;
      height: 14px;
      border-radius: 3px;
      pointer-events: none;
      z-index: 9999;
      opacity: 0;
    }
    @keyframes confetti-fall {
      0% { transform: translate3d(var(--x, 0), -10vh, 0) rotateZ(0deg); opacity: 1; }
      100% { transform: translate3d(var(--xEnd, 0), 110vh, 0) rotateZ(260deg); opacity: 0; }
    }
    @media (max-width: 600px) {
      .app { margin: 10px; border-radius: 18px; padding: 18px 16px 20px; }
      .prompt-text { font-size: 1.2rem; }
      .title-block h1 { font-size: 1.25rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="mascot" id="mascot">
        <div class="mascot-ear left"></div>
        <div class="mascot-ear right"></div>
        <div class="mascot-face">ü¶ä</div>
      </div>
      <div class="title-block">
        <h1>Japanese Quest <span class="difficulty-tag">Beginner N5</span></h1>
        <p class="subtitle">Fox Sensei will guide you ‚Ä¢ 30 questions ‚Ä¢ Sounds + XP</p>
      </div>
    </header>

    <div class="xp-bar-wrap">
      <div class="xp-label">XP: <span id="xp-value">0</span> / 300</div>
      <div class="xp-bar">
        <div class="xp-fill" id="xp-fill"></div>
        <div class="xp-floater" id="xp-floater">+10 XP</div>
      </div>
    </div>

    <div class="progress-wrapper">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="progress-text" id="progress-text">Question 1 / 30</div>

    <div class="question-box">
      <div class="question-meta" id="question-meta"></div>
      <div class="question-text" id="question-text"></div>
      <div class="prompt-text" id="prompt-text"></div>
      <div class="direction-text" id="direction-text"></div>
    </div>

    <div class="options" id="options"></div>

    <div class="feedback" id="feedback"></div>

    <div class="bottom-bar">
      <div class="score-text">
        Score: <span id="score-value">0</span> / 30
        <small id="streak-text">Streak: 0 üî•</small>
      </div>
      <button class="primary-btn" id="next-btn" disabled>
        Next <span id="next-label">‚ñ∂</span>
      </button>
    </div>

    <div class="summary" id="summary"></div>
  </div>

  <script>
    const questions = [
      { meta: "Greetings", question: "Japanese for ‚ÄúHello‚Äù?", prompt: "Hello", direction: "Choose the best translation.", options: ["„Åï„Çà„ÅÜ„Å™„Çâ", "„Åì„Çì„Å´„Å°„ÅØ", "„ÅÇ„Çä„Åå„Å®„ÅÜ", "„Åä„ÅØ„Çà„ÅÜ"], correctIndex: 1, explanation: "„Äå„Åì„Çì„Å´„Å°„ÅØ„Äç means hello (daytime greeting)." },
      { meta: "Numbers", question: "What is ‚Äúone‚Äù?", prompt: "one", direction: "Choose the correct word.", options: ["„ÅÑ„Å°", "„Å´", "„Åï„Çì", "„Çà„Çì"], correctIndex: 0, explanation: "„Äå„ÅÑ„Å°„Äç means one." },
      { meta: "Polite forms", question: "Polite ‚ÄúThank you‚Äù?", prompt: "Thank you", direction: "Choose the polite form.", options: ["„ÅÇ„Çä„Åå„Å®„ÅÜ", "„Åî„ÇÅ„Çì", "„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô", "„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô"], correctIndex: 3, explanation: "„Äå„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„Äç is the polite form of thank you." },
      { meta: "Farewell", question: "Meaning of „Åï„Çà„ÅÜ„Å™„Çâ?", prompt: "„Åï„Çà„ÅÜ„Å™„Çâ", direction: "Choose the English meaning.", options: ["Goodbye", "Good night", "Excuse me", "Please"], correctIndex: 0, explanation: "„Äå„Åï„Çà„ÅÜ„Å™„Çâ„Äç is used as goodbye." },
      { meta: "Feelings", question: "‚ÄúHappy‚Äù in Japanese?", prompt: "happy", direction: "Choose the closest everyday word.", options: ["„Åó„ÅÇ„Çè„Åõ", "„ÅÇ„Å§„ÅÑ", "„Å≤„Åæ", "„Åã„Çè„ÅÑ„ÅÑ"], correctIndex: 0, explanation: "„Äå„Åó„ÅÇ„Çè„Åõ„Äç means happy / fortunate." },
      { meta: "Food", question: "Meaning of „Åø„Åö?", prompt: "„Åø„Åö", direction: "Choose the best translation.", options: ["rice", "water", "fish", "tea"], correctIndex: 1, explanation: "„Äå„Åø„Åö„Äç means water." },
      { meta: "People", question: "Word for ‚Äúfriend‚Äù?", prompt: "friend", direction: "Choose the best translation.", options: ["„Å®„ÇÇ„Å†„Å°", "„Åã„Åû„Åè", "„Åõ„Çì„Åõ„ÅÑ", "„Åì„Å©„ÇÇ"], correctIndex: 0, explanation: "„Äå„Å®„ÇÇ„Å†„Å°„Äç means friend." },
      { meta: "People", question: "Meaning of „Åõ„Çì„Åõ„ÅÑ?", prompt: "„Åõ„Çì„Åõ„ÅÑ", direction: "Choose the English meaning.", options: ["student", "teacher", "doctor", "friend"], correctIndex: 1, explanation: "„Äå„Åõ„Çì„Åõ„ÅÑ„Äç means teacher." },
      { meta: "Time", question: "‚ÄúMorning‚Äù in Japanese?", prompt: "morning", direction: "Choose the best translation.", options: ["„Çà„Çã", "„ÅÇ„Åó„Åü", "„ÅÇ„Åï", "„Å≤„Çã"], correctIndex: 2, explanation: "„Äå„ÅÇ„Åï„Äç means morning." },
      { meta: "Time", question: "‚ÄúNight‚Äù in Japanese?", prompt: "night", direction: "Choose the best translation.", options: ["„ÅÇ„Åï", "„Å≤„Çã", "„Çà„Çã", "„Åç„Çá„ÅÜ"], correctIndex: 2, explanation: "„Äå„Çà„Çã„Äç means night." },
      { meta: "Hiragana", question: "Which hiragana is ‚Äúa‚Äù?", prompt: "a", direction: "Choose the correct character.", options: ["„ÅÇ", "„ÅÑ", "„ÅÜ", "„Åä"], correctIndex: 0, explanation: "„Äå„ÅÇ„Äç is the hiragana for 'a'." },
      { meta: "Hiragana", question: "Which is ‚Äúki‚Äù?", prompt: "ki", direction: "Choose the correct character.", options: ["„Åì", "„Åè", "„Åç", "„Åã"], correctIndex: 2, explanation: "„Äå„Åç„Äç is the hiragana for 'ki'." },
      { meta: "Hiragana", question: "Which is ‚Äúsu‚Äù?", prompt: "su", direction: "Choose the correct character.", options: ["„Åô", "„Åó", "„Åõ", "„Åù"], correctIndex: 0, explanation: "„Äå„Åô„Äç is the hiragana for 'su'." },
      { meta: "Hiragana", question: "Which is ‚Äúno‚Äù?", prompt: "no", direction: "Choose the correct character.", options: ["„Å¨", "„Å≠", "„ÅÆ", "„Å™"], correctIndex: 2, explanation: "„Äå„ÅÆ„Äç is the hiragana for 'no'." },
      { meta: "Hiragana", question: "Which is ‚Äúta‚Äù?", prompt: "ta", direction: "Choose the correct character.", options: ["„Åü", "„Å¶", "„Å°", "„Å®"], correctIndex: 0, explanation: "„Äå„Åü„Äç is the hiragana for 'ta'." },
      { meta: "Hiragana", question: "Which is ‚Äúri‚Äù?", prompt: "ri", direction: "Choose the correct character.", options: ["„Çã", "„Çå", "„Çä", "„Çç"], correctIndex: 2, explanation: "„Äå„Çä„Äç is the hiragana for 'ri'." },
      { meta: "Hiragana", question: "Spell ‚Äúneko‚Äù", prompt: "neko", direction: "Choose the correct spelling.", options: ["„Å≠„Åë", "„Å≠„Åì", "„Å¨„Åì", "„Å≠„Åè"], correctIndex: 1, explanation: "„Äå„Å≠„Åì„Äç spells neko (cat)." },
      { meta: "Hiragana", question: "Spell ‚Äúsushi‚Äù", prompt: "sushi", direction: "Choose the correct spelling.", options: ["„Åô„Åó", "„Åô„Å≤", "„Åó„Åô", "„Åô„ÅÜ„Åó"], correctIndex: 0, explanation: "„Äå„Åô„Åó„Äç spells sushi." },
      { meta: "Hiragana", question: "Spell ‚Äúkumo‚Äù", prompt: "kumo", direction: "Choose the correct spelling.", options: ["„Åè„Åæ", "„Åè„ÇÇ", "„Åì„ÇÇ", "„Åã„ÇÇ"], correctIndex: 1, explanation: "„Äå„Åè„ÇÇ„Äç spells kumo (cloud/spider)." },
      { meta: "Hiragana", question: "Reading of „Åü„Åπ„Çã?", prompt: "„Åü„Åπ„Çã", direction: "Choose the correct romaji reading.", options: ["taberu", "tabero", "tobira", "tabura"], correctIndex: 0, explanation: "„Äå„Åü„Åπ„Çã„Äç is read taberu (to eat)." },
      { meta: "Phrase", question: "Meaning of „Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô?", prompt: "„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô", direction: "Choose the English meaning.", options: ["Good evening", "Good morning (polite)", "See you later", "Nice to meet you"], correctIndex: 1, explanation: "„Äå„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„Äç is polite good morning." },
      { meta: "Phrase", question: "Japanese for ‚ÄúGood night‚Äù?", prompt: "Good night", direction: "Choose the best translation.", options: ["„Åì„Çì„Å∞„Çì„ÅØ", "„Åì„Çì„Å´„Å°„ÅØ", "„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ", "„Åò„ÇÉ„ÅÇ„Å≠"], correctIndex: 2, explanation: "„Äå„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ„Äç means good night." },
      { meta: "Phrase", question: "Meaning of „Åî„ÇÅ„Çì„Å™„Åï„ÅÑ?", prompt: "„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ", direction: "Choose the English meaning.", options: ["Thank you", "I‚Äôm sorry", "Excuse me", "See you"], correctIndex: 1, explanation: "„Äå„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ„Äç means I'm sorry." },
      { meta: "Grammar", question: "Function of „ÅØ in ÁßÅ„ÅØÂ≠¶Áîü„Åß„Åô?", prompt: "ÁßÅ„ÅØÂ≠¶Áîü„Åß„Åô", direction: "Choose the best description.", options: ["Marks the object", "Marks the topic", "Marks the location", "Marks possession"], correctIndex: 1, explanation: "Particle „Äå„ÅØ„Äç (wa) marks the topic." },
      { meta: "Grammar", question: "Function of „Åß„Åô?", prompt: "Êó•Êú¨‰∫∫„Åß„Åô", direction: "Choose the best explanation.", options: ["Means 'not'", "Indicates past", "Polite ending / 'to be'", "Marks location"], correctIndex: 2, explanation: "„Äå„Åß„Åô„Äç is a polite sentence ending (like 'to be')." },
      { meta: "Phrase", question: "How to say ‚ÄúI understand‚Äù?", prompt: "I understand", direction: "Choose the common phrase.", options: ["„Åø„Åà„Åæ„Åô", "„Åó„Çä„Åæ„Åô", "„Çè„Åã„Çä„Åæ„Åô", "„Åç„Åì„Åà„Åæ„Åô"], correctIndex: 2, explanation: "„Äå„Çè„Åã„Çä„Åæ„Åô„Äç means I understand." },
      { meta: "Phrase", question: "Nice to meet you (after intro)?", prompt: "Nice to meet you", direction: "Choose the standard phrase.", options: ["„Åì„Çì„Å´„Å°„ÅØ", "„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶", "„Çà„Çç„Åó„Åè„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô", "„ÅÇ„Çä„Åå„Å®„ÅÜ"], correctIndex: 2, explanation: "After introducing yourself, you say „Äå„Çà„Çç„Åó„Åè„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô„Äç." },
      { meta: "Phrase", question: "Meaning of „Åä„Åí„Çì„Åç„Åß„Åô„Åã?", prompt: "„Åä„Åí„Çì„Åç„Åß„Åô„ÅãÔºü", direction: "Choose the English meaning.", options: ["Are you busy?", "How are you?", "Where are you from?", "What time is it?"], correctIndex: 1, explanation: "„Äå„Åä„Åí„Çì„Åç„Åß„Åô„ÅãÔºü„Äç means how are you?" },
      { meta: "Phrase", question: "How to say ‚ÄúI am American‚Äù?", prompt: "I am American", direction: "Choose the best translation.", options: ["„Ç¢„É°„É™„Ç´„Åò„Çì„Åß„Åô", "„Ç¢„É°„É™„Ç´„Åî„Åß„Åô", "„Ç¢„É°„É™„Ç´„Å´„Åß„Åô", "„Ç¢„É°„É™„Ç´„ÅØ„Åß„Åô"], correctIndex: 0, explanation: "„Äå„Ç¢„É°„É™„Ç´„Åò„Çì„Åß„Åô„Äç means (I) am American." },
      { meta: "Phrase", question: "How to say ‚ÄúI don‚Äôt understand‚Äù?", prompt: "I don‚Äôt understand", direction: "Choose the best phrase.", options: ["„Çè„Åã„Çä„Åæ„Åõ„Çì", "„Çè„Åã„Çä„Åæ„Åô", "„Çè„Åã„Çâ„Å™„ÅÑÔºü", "„Çè„Åã„Å£„Å¶„Åè„Å†„Åï„ÅÑ"], correctIndex: 0, explanation: "„Äå„Çè„Åã„Çä„Åæ„Åõ„Çì„Äç is the polite I don't understand." }
    ];

    let currentIndex = 0;
    let score = 0;
    let streak = 0;
    let xp = 0;
    let answered = false;

    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");
    const questionMeta = document.getElementById("question-meta");
    const questionText = document.getElementById("question-text");
    const promptText = document.getElementById("prompt-text");
    const directionText = document.getElementById("direction-text");
    const optionsContainer = document.getElementById("options");
    const feedbackEl = document.getElementById("feedback");
    const scoreValueEl = document.getElementById("score-value");
    const streakTextEl = document.getElementById("streak-text");
    const nextBtn = document.getElementById("next-btn");
    const nextLabel = document.getElementById("next-label");
    const summaryEl = document.getElementById("summary");
    const xpFill = document.getElementById("xp-fill");
    const xpValue = document.getElementById("xp-value");
    const xpFloater = document.getElementById("xp-floater");
    const mascotEl = document.getElementById("mascot");

    let audioCtx = null;
    function ensureAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playBeep(type) {
      ensureAudioContext();
      const duration = type === "correct" ? 0.18 : 0.22;
      const frequency = type === "correct" ? 880 : 220;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type === "correct" ? "triangle" : "sawtooth";
      osc.frequency.value = frequency;
      gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    }

    function playClick() {
      ensureAudioContext();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "square";
      osc.frequency.value = 120;
      gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.25, audioCtx.currentTime + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.09);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.1);
    }

    function playCelebrate() {
      ensureAudioContext();
      [880, 1320, 1760].forEach((freq, i) => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = freq;
        const start = audioCtx.currentTime + i * 0.06;
        const end = start + 0.18;
        gain.gain.setValueAtTime(0.001, start);
        gain.gain.exponentialRampToValueAtTime(0.3, start + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.001, end);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(start);
        osc.stop(end);
      });
    }

    function addXP(amount) {
      xp += amount;
      if (xp > 300) xp = 300;
      xpValue.textContent = xp;
      const pct = (xp / 300) * 100;
      xpFill.style.width = pct + "%";

      xpFloater.textContent = "+" + amount + " XP";
      xpFloater.classList.add("show");
      setTimeout(() => xpFloater.classList.remove("show"), 500);
    }

    function wiggleMascot(happy) {
      mascotEl.style.transition = "transform 0.15s ease";
      mascotEl.style.transform = happy ? "translateY(-2px) rotate(-4deg)" : "translateY(1px) rotate(4deg)";
      setTimeout(() => {
        mascotEl.style.transform = "translateY(0) rotate(0deg)";
      }, 180);
    }

    function fireConfetti() {
      const colors = ["#f97316", "#fb7185", "#22c55e", "#38bdf8", "#a855f7"];
      const petals = 90;
      for (let i = 0; i < petals; i++) {
        const piece = document.createElement("div");
        piece.className = "confetti-piece";
        const color = colors[Math.floor(Math.random() * colors.length)];
        piece.style.background = color;
        const x = (Math.random() * 100) - 50;
        const xEnd = x + (Math.random() * 40 - 20);
        piece.style.setProperty("--x", x + "vw");
        piece.style.setProperty("--xEnd", xEnd + "vw");
        piece.style.left = (50 + x) + "vw";
        piece.style.top = "-10vh";
        piece.style.opacity = "1";
        const duration = 2.5 + Math.random() * 1.2;
        piece.style.animation = "confetti-fall " + duration.toFixed(2) + "s ease-out forwards";
        document.body.appendChild(piece);
        setTimeout(() => piece.remove(), duration * 1000 + 200);
      }
    }

    function renderQuestion() {
      const q = questions[currentIndex];
      answered = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      nextBtn.disabled = true;
      nextLabel.textContent = currentIndex === questions.length - 1 ? "Finish" : "‚ñ∂";

      const progressPercent = (currentIndex / questions.length) * 100;
      progressBar.style.width = progressPercent + "%";
      progressText.textContent = "Question " + (currentIndex + 1) + " / " + questions.length;

      questionMeta.textContent = q.meta;
      questionText.textContent = q.question;
      promptText.textContent = q.prompt || "";
      directionText.textContent = q.direction || "";

      optionsContainer.innerHTML = "";
      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt;
        btn.addEventListener("click", (evt) => {
          const rect = btn.getBoundingClientRect();
          const x = ((evt.clientX - rect.left) / rect.width) * 100;
          const y = ((evt.clientY - rect.top) / rect.height) * 100;
          btn.style.setProperty("--x", x + "%");
          btn.style.setProperty("--y", y + "%");
          playClick();
          handleAnswer(idx, btn);
        });
        optionsContainer.appendChild(btn);
      });
    }

    function handleAnswer(selectedIndex, selectedBtn) {
      if (answered) return;
      answered = true;
      const q = questions[currentIndex];
      const optionButtons = Array.from(document.querySelectorAll(".option-btn"));
      optionButtons.forEach((btn, idx) => {
        btn.classList.add("disabled");
        if (idx === q.correctIndex) {
          btn.classList.add("correct");
        }
      });

      const isCorrect = selectedIndex === q.correctIndex;
      if (!isCorrect) {
        selectedBtn.classList.add("wrong");
      }

      if (isCorrect) {
        score++;
        streak++;
        feedbackEl.textContent = "Correct! " + (q.explanation || "");
        feedbackEl.classList.add("correct");
        playBeep("correct");
        wiggleMascot(true);
        addXP(10 + Math.min(streak - 1, 3) * 5);
      } else {
        streak = 0;
        feedbackEl.textContent = "Not quite. " + (q.explanation || "");
        feedbackEl.classList.add("wrong");
        playBeep("wrong");
        wiggleMascot(false);
        addXP(2);
      }

      scoreValueEl.textContent = score;
      streakTextEl.textContent = "Streak: " + streak + (streak >= 3 ? " üî•" : "");
      nextBtn.disabled = false;

      if (currentIndex === questions.length - 1) {
        nextLabel.textContent = "Finish";
      }
    }

    function showSummary() {
      const total = questions.length;
      const percentage = Math.round((score / total) * 100);
      let message;
      if (percentage === 100) {
        message = "Perfect! Fox Sensei is extremely impressed. Ready for harder levels!";
      } else if (percentage >= 80) {
        message = "Great job! Keep reviewing and you‚Äôll level up fast.";
      } else if (percentage >= 50) {
        message = "Nice start! Replaying will help the words stick.";
      } else {
        message = "Every kanji master starts at 0 XP. Try again‚Äîyou‚Äôll improve quickly.";
      }

      summaryEl.innerHTML = `
        <div class="badge">Session complete</div>
        <h2>Your Score: ${score} / ${total}</h2>
        <p>${percentage}% correct ‚Ä¢ XP earned: ${xp}</p>
        <p>${message}</p>
        <p style="margin-top:6px;font-size:0.82rem;color:#6b7280;">Tip: Repeat the quiz until you can answer without thinking‚Äîit‚Äôs spaced repetition, Fox Sensei style.</p>
        <button class="primary-btn" id="restart-btn">Play again üîÅ</button>
      `;
      summaryEl.style.display = "block";
      playCelebrate();
      fireConfetti();

      document.querySelector(".question-box").style.display = "none";
      optionsContainer.style.display = "none";
      feedbackEl.style.display = "none";
      document.querySelector(".bottom-bar").style.display = "none";
      document.querySelector(".progress-wrapper").style.display = "none";
      progressText.style.display = "none";

      document.getElementById("restart-btn").addEventListener("click", () => {
        currentIndex = 0;
        score = 0;
        streak = 0;
        xp = 0;
        scoreValueEl.textContent = "0";
        streakTextEl.textContent = "Streak: 0 üî•";
        xpFill.style.width = "0%";
        xpValue.textContent = "0";
        summaryEl.style.display = "none";
        document.querySelector(".question-box").style.display = "";
        optionsContainer.style.display = "";
        feedbackEl.style.display = "";
        document.querySelector(".bottom-bar").style.display = "";
        document.querySelector(".progress-wrapper").style.display = "";
        progressText.style.display = "";
        renderQuestion();
      });
    }

    nextBtn.addEventListener("click", () => {
      playClick();
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
      } else {
        progressBar.style.width = "100%";
        progressText.textContent = "Question " + questions.length + " / " + questions.length;
        showSummary();
      }
    });

    document.body.addEventListener("click", () => ensureAudioContext(), { once: true });

    renderQuestion();
  </script>
</body>
</html>
